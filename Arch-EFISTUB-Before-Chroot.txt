#!/bin/bash
## 友情提示:
## 如果发现报错信息包含/M可使用vim在命令行模式键入":set fileformat=unix"转为linux文件即可
## 上传安装脚本可以使用xshell自带的ftp工具或WinSCP等工具,或直接拷贝内容到shell脚本使用bash Arch-EFISTUB-Before-Chroot.txt运行即可
## 我只单独分了root分区,使用的是UEFI所以不需要boot分区,而是esp分区
## 由于每个人的分区和挂载编好不同,所以仍需要稍微调整一下以符合自己的期望
## 调整方法参考一下代码的Parted Table部分

## 注意
## 需要安装的磁盘,这里一定要修改为所要安装的磁盘
disk="sda"

## -----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
## -----+-----+-----+-----				安装小脚本				 -----+-----+-----+-----+-----+
## -----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
info(){
	  echo "-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+"
	  printf "%-35s %-16s %35s\n" "-----+" "${1}" "           -----+"
	  echo "-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+"
}
read -p "确定你要安装的磁盘是[n/y]:$disk,如果不是请修改继续 " isTheDisk
if [ "$isTheDisk" == "n" ]
	then
		info "退出安装"
		exit
fi
info "安装开始"

## 设置时区同步
timedatectl set-ntp true

## 											清空分区
## >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
devNames=`lsblk -lo name| grep $disk`
function clearDevParts
{
	rex="^$disk[0-9]$"
	while test $# -gt 0
		do
		result=$(echo $1 | grep $rex )
		if [[ "$result" != "" ]]
			then
			echo "正在删除: $1 分区"
			rmPart=$1
			eval "parted /dev/$disk rm ${rmPart: -1}" 
		fi
		shift
	done
}
clearDevParts $devNames
## >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>


## =============================================================================================
## |							 Parted Table 		   				           				   |
## =============================================================================================
echo "yes" | parted "/dev/$disk" mklabel gpt
## esp分区
parted "/dev/$disk" mkpart primary fat32 1M 160M
## 根分区		
parted "/dev/$disk" mkpart primary ext4 160M 100%		
parted "/dev/$disk" set 1 boot on

## 

info 格式化开始
eval "mkfs.fat -F32 /dev/${disk}1 && mkfs.ext4 /dev/${disk}2"

## 								挂载分区这里调整	
## -----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+					
eval "mount /dev/${disk}2 /mnt && mkdir -p /mnt/boot && mount /dev/${disk}1 /mnt/boot"					  	
## -----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+	

lsblk
sleep 3
info 格式化结束
## =============================================================================================
## |							 Parted Table 		   				           				   |
## =============================================================================================







## 											设置镜像
## >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
wget -O /etc/pacman.d/mirrorlist "http://www.archlinux.org/mirrorlist/?country=CN&protocol=https&ip_version=4"
sed -i "s/#Server/Server/g" /etc/pacman.d/mirrorlist && cat /etc/pacman.d/mirrorlist
## >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>


## 											安装软件包
## >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
info 安装软件包开始
pacstrap /mnt base base-devel linux linux-firmware
info 安装软件包结束
## >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

## 配置系统
genfstab -U /mnt >> /mnt/etc/fstab
lsblk
info ''

## 											切换到磁盘并设置分区
## >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
info '请注意提示:'
info '请注意提示:'
info '请注意提示:'
info '即将切换系统,请注意:'
info '切换系统后应将Arch-EFISTUB-After-Chroot.txt的内容手动拷贝shell脚本完成最后的安装'

arch-chroot /mnt 

## 											安装完成
## >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
info 安装完成
info "系统即将重启"
info "Thank U For Use"

sleep 5
umount -R /mnt && reboot







